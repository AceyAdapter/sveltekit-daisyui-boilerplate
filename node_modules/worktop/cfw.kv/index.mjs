var t=Object.defineProperty,e=(e,i,a)=>(((e,i,a)=>{i in e?t(e,i,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[i]=a})(e,"symbol"!=typeof i?i+"":i,a),a);function i(t){return"string"==typeof t||t instanceof ArrayBuffer||t instanceof ReadableStream?t:JSON.stringify(t)}function a(t){var e=(t,e)=>`${t}__${e}`;return{get:(i,a,r)=>n(t,e(i,a),r),put:(i,a,n,s)=>r(t,e(i,a),n,{toJSON:!0,...s}),del:(i,a)=>s(t,e(i,a))}}function n(t,e,i="json"){return"string"!=typeof i&&i.metadata?t.getWithMetadata(e,i):t.get(e,i)}function r(t,e,i,a){let n=(!a||!a.toJSON)&&"string"==typeof i||i instanceof ArrayBuffer||i instanceof ReadableStream?i:JSON.stringify(i);return t.put(e,n,a).then((()=>!0),(()=>!1))}function s(t,e){return t.delete(e).then((()=>!0),(()=>!1))}async function*l(t,e){let{prefix:i,limit:a,cursor:n,metadata:r}=e||{};for(;;){let e=await t.list({prefix:i,limit:a,cursor:n});if(n=e.cursor,yield{done:e.list_complete,keys:r?e.keys:e.keys.map((t=>t.name))},e.list_complete)return}}async function u(t,e){let{prefix:i,metadata:a=!1,limit:n=50,page:r=1}=e||{},s=l(t,{prefix:i,limit:n,metadata:a});for await(let t of s){if(--r&&t.done)return[];if(0===r)return t.keys}return[]}async function f(t,e){let i,a="";for(;;)if(i=await e(a=t()),null==i)return a}function h(t,e){return!t||e.startsWith(t+"~")?e:t+"~"+e}var o=class{constructor(t){e(this,"ns"),e(this,"cache"),e(this,"prefix",""),e(this,"ttl",0),this.cache=new class{get(t){return caches.default.match(t)}put(t,e,a){if(!a)return Promise.resolve(!0);let n={"cache-control":`public,max-age=${a}`},r=null==e?null:i(e),s=new Response(r,{headers:n});return caches.default.put(t,s).then((()=>!0),(()=>!1))}delete(t){return caches.default.delete(t)}},this.ns=t}async list(t){t=t||{};let{limit:e,prefix:i=""}=t;this.prefix&&(t.prefix=h(this.prefix,i)),e&&(t.limit=Math.min(1e3,e));let a=l(this.ns,{...t,metadata:!1}),n=[];for await(let t of a){for(let i=0,a=this.prefix.length;i<t.keys.length;i++)if(n.push(t.keys[i].substring(a)),e&&n.length===e)return n;if(t.done)break}return n}async get(t,e="json"){t=h(this.prefix,t);let i,a=this.ttl&&await this.cache.get(t);return a?i=await a[e]():(i=await this.ns.get(t,e),this.ttl&&await this.cache.put(t,i,this.ttl)),this.onread&&await this.onread(t,i),i}async put(t,e){t=h(this.prefix,t);let a=i(e),n=await this.ns.put(t,a).then((()=>!0),(()=>!1));if(n&&this.ttl){let i=null==e?null:a;n=await this.cache.put(t,i,this.ttl)}return n&&this.onwrite&&await this.onwrite(t,e),n}async delete(t,e="json"){t=h(this.prefix,t);let i="function"==typeof this.ondelete,a=i&&await this.ns.get(t,e),n=await this.ns.delete(t).then((()=>!0),(()=>!1));return n&&this.ttl&&(n=await this.cache.delete(t)),n&&i&&await this.ondelete(t,a),n}};export{a as Database,o as Entity,l as list,u as paginate,n as read,s as remove,f as until,r as write};